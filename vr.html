<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/0.8.0/aframe.min.js"></script>
    <!-- <script src="https://unpkg.com/aframe-look-at-component@0.5.1/dist/aframe-look-at-component.min.js"></script> -->
    <script>
      //TODO: Make Annie 'walk' to person rather than teleport - add animation
      //TODO: Add HUD w/directions
      //TODO: Figure out how to get Annie to be 'in front' of you when she walks to you

      let DEBUGTIMER = false;
      let DEBUGANNIEROTATE = true;
      let midRotation = false;
      let rot;

      AFRAME.registerComponent('follow-on-click', {
        init: function () {
          let el = this.el;
          el.addEventListener('click', function () {
            let cam = document.querySelector("#camera");
            let camPos = cam.getAttribute('position');
            let camRot = cam.getAttribute('rotation');
            console.log(camRot);
            let annie = document.querySelector("#Annie");
            let anniePos = annie.getAttribute('position');
            let annieZ = camPos.z - 6*Math.cos(camRot.y * Math.PI / 180);
            let annieX = camPos.x - 6*Math.sin(camRot.y * Math.PI / 180);
            annie.setAttribute('position', {x: annieX, y: camPos.y - 4, z: annieZ});
            //annie.setAttribute('position', {x: camPos.x, y: camPos.y - 4, z: camPos.z - 6});
            /*
            annie.setAttribute('position', {x: camPos.x, y: camPos.y - 4, z: camPos.z - 6});
            var annieEls = document.querySelectorAll(".AnnieElt");
            annieEls.forEach(function(elt) {
              elt.setAttribute('color', '#4444FF');
            });
            */
            //rotateAnnie();
          });

          el.addEventListener('mouseenter', function() {
            rotateAnnie();
          });
        }
      });

      function rotateAnnie() {
        //let rotAnim = document.querySelector("#AnnieRotationAnimation");
        let cam = document.querySelector("#camera");
        let camPos = cam.getAttribute('position');
        let annie = document.querySelector("#Annie");
        let anniePos = annie.getAttribute('position');
        let annieRot = annie.getAttribute('rotation');
        let xRot = camPos.x - anniePos.x;
        let zRot = camPos.z - anniePos.z;
        rot = Math.atan(xRot / zRot);
        //console.log("x's: " + xRot);
        //console.log("z's: " + zRot);
        rot = (rot * 180) / Math.PI;
        //console.log('original rot: ' + rot);
        if(zRot < 0) {
          rot = -180 + rot;
        }

        let animationStr = `<a-animation id="AnnieRotationAnimation" attribute="rotation"
                 dur="1000"
                 easing="linear"
                 from="${annieRot.x} ${annieRot.y} ${annieRot.z}"
                 to="${annieRot.x} ${rot} ${annieRot.z}">
                 </a-animation>`

        //console.log('new rot: ' + rot);
        //console.log("");
        //console.log("1");
        if(DEBUGANNIEROTATE) {
          //tries to animate the rotation as a turn
          //console.log("2");
          if(!midRotation) {
            //console.log("3");
            //console.log(annieRot)
            let animationBlock = document.createElement("a-animation");
            animationBlock.setAttribute("id", "AnnieRotationAnimation");
            animationBlock.setAttribute("attribute", "rotation");
            animationBlock.setAttribute("dur", "1000");
            animationBlock.setAttribute("easing", "linear");
            animationBlock.setAttribute("from", `${annieRot.x} ${annieRot.y} ${annieRot.z}`);
            animationBlock.setAttribute("to", `${annieRot.x} ${rot} ${annieRot.z}`);
            //animationBlock.setAttribute("begin", "startAnimation");
            annie.appendChild(animationBlock);
            midRotation = true;
            //annie.emit("startAnimation");
            //annie.setAttribute('rotation', {x: annieRot.x, y: rot, z: annieRot.z});
            //annie.emit("startRotation");
            setTimeout(function() {
              //console.log("4");
              midRotation = false;
              let annie = document.querySelector("#Annie");
              let anim = document.querySelector("#AnnieRotationAnimation");
              annie.removeChild(anim);
              //annie.setAttribute('rotation', {x: annieRot.x, y: rot, z: annieRot.z});
            }, 1000);
          }
        } else {
          //triggers the animation instantly, like a teleport
          annie.setAttribute('rotation', {x: annieRot.x, y: rot, z: annieRot.z});
        }

      }
    </script>
  </head>
  <body>
    <a-scene>
      <!-- START CAMERA -->
    <a-entity id="camera" camera="active: true" look-controls wasd-controls position="0 0 0" data-aframe-default-camera>
      <a-cursor></a-cursor>
    </a-entity>
    <!-- END CAMERA -->

    <!-- START ANNIE -->
		<a-entity id="Annie" position="0 -4 -6" follow-on-click>
      <!-- START BODY -->
			<a-entity id="body" position="0 2 0">
				<a-box class="AnnieElt" src="https://mathymcmatherson.github.io/anniewebsitestatic/images/cow.jpg" position="0 0 0" width="2" height="2" depth="4"></a-box>
			</a-entity>
      <!-- END BODY -->
      <!-- START LEGS -->
			<a-entity id="legs" position="0 0 0">
        <!-- START FRONT RIGHT LEG -->
        <a-entity id="front-right-leg" position="-0.74 0.5 1.25">
					<a-box class="AnnieElt" src="https://mathymcmatherson.github.io/anniewebsitestatic/images/cow.jpg" width="0.5" height="2.5" depth="0.5" position="0 0 0"></a-box>
          <a-animation attribute="rotation"
								 dur="1000"
								 direction="alternate"
                 from="30 0 0"
								 to="-30 0 0"
								 repeat="indefinite"
								 easing="linear"></a-animation>
				</a-entity>
        <!-- END FRONT RIGHT LEG -->
        <!-- START FRONT LEFT LEG -->
        <a-entity id="front-left-leg" position="0.74 0.5 1.25">
  				<a-box class="AnnieElt" src="https://mathymcmatherson.github.io/anniewebsitestatic/images/cow.jpg" width="0.5" height="2.5" depth="0.5" position="0 0 0"></a-box>
          <a-animation attribute="rotation"
                 dur="1000"
                 direction="alternate"
                 from="-30 0 0"
                 to="30 0 0"
                 repeat="indefinite"
                 easing="linear"></a-animation>
        </a-entity>
        <!-- END FRONT LEFT LEG -->
        <!-- START BACK RIGHT LEG -->
        <a-entity id="back-right-leg" position="-0.74 0.5 -1.25">
          <a-box class="AnnieElt" src="https://mathymcmatherson.github.io/anniewebsitestatic/images/cow.jpg" width="0.5" height="2.5" depth="0.5" position="0 0 0"></a-box>
          <a-animation attribute="rotation"
                 dur="1000"
                 direction="alternate"
                 from="-30 0 0"
                 to="30 0 0"
                 repeat="indefinite"
                 easing="linear"></a-animation>
        </a-entity>
        <!-- END BACK RIGHT LEG -->
        <!-- START BACK LEFT LEG -->
        <a-entity id="back-left-leg" position="0.74 0.5 -1.25">
				      <a-box class="AnnieElt" src="https://mathymcmatherson.github.io/anniewebsitestatic/images/cow.jpg" width="0.5" height="2.5" depth="0.5" position="0 0 0"></a-box>
              <a-animation attribute="rotation"
                     dur="1000"
                     direction="alternate"
                     from="30 0 0"
                     to="-30 0 0"
                     repeat="indefinite"
                     easing="linear"></a-animation>
        </a-entity>
        <!-- END BACK LEFT LEG -->
      </a-entity>
      <!-- END LEGS -->
      <!-- START HEAD -->
			<a-entity id="head" position="0 4 0">
				<a-box class="AnnieElt" src="https://mathymcmatherson.github.io/anniewebsitestatic/images/cow.jpg" position="0 0 1.5" width="2" height="2" depth="2"></a-box>
        <!-- START EARS -->
				<a-entity id="ears" position="0 1.25 2.25">
					<a-box class="AnnieElt" position="-0.75 0 0" color="#444444" width="0.5" height="0.5" depth="0.5"></a-box>
					<a-box class="AnnieElt" position="0.75 0 0" color="#444444" width="0.5" height="0.5" depth="0.5"></a-box>
				</a-entity>
        <!-- END EARS -->
			</a-entity>
      <!-- END HEAD -->
		</a-entity>
    <!-- END ANNIE -->



		<a-sky color="#ECECEC"></a-sky>
    </a-scene>
    <script>
      /*if(DEBUGANNIEROTATE) {
        document.querySelector("#AnnieRotationAnimation").addEventListener('animationend', function() {
          let annie = document.querySelector("#Annie");
          let rotAnim = document.querySelector("#AnnieRotationAnimation");
          let finalPosStr = rotAnim.getAttribute('to').split(" ");
          let finalPos = finalPosStr.map(x => parseFloat(x));
          //console.log(finalPos);
          annie.setAttribute('rotation', {x: finalPos[0], y: finalPos[1], z: finalPos[2]});
        });
      }*/
    </script>
  </body>
</html>
